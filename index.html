<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>カレー モバイルオーダー</title>
  <style>
    :root { --control: 360px; --fieldset: 480px; --gap: 12px; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      padding: 16px; margin: 0 auto; max-width: 840px;
      display: flex; flex-direction: column; align-items: center; background: #fff;
    }
    h1 { font-size: 1.6rem; margin: .2rem 0 .6rem; text-align: center; }
    p.muted { color: #666; font-size: .95rem; text-align: center; margin: 0 0 8px; }
    .wrap { width: 100%; display: flex; flex-direction: column; align-items: center; }
    fieldset {
      width: min(100%, var(--fieldset)); border: 1px solid #ddd; border-radius: 12px;
      padding: 20px; margin: 14px 0; background: #fff;
    }
    legend { padding: 0 6px; font-weight: 700; font-size: 1.1rem; }
    label { display: block; margin: 10px 0 6px; }
    .row { display: flex; gap: var(--gap); align-items: center; flex-wrap: wrap; }
    .ctrl { width: var(--control); max-width: 100%; display: block; margin: 0 auto; }
    select.ctrl, input.ctrl, textarea.ctrl {
      padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; background: #fff;
    }
    .radios { display: flex; flex-direction: column; gap: 6px; }
    .radios.ctrl { align-items: flex-start; }
    .total.ctrl { font-size: 1.2rem; font-weight: 700; text-align: right; margin: 8px auto 0; }
    .msg { width: min(100%, var(--fieldset)); }
    .success { background: #e6ffed; border: 1px solid #b7f5c4; padding: 12px; border-radius: 8px; }
    .error { background: #ffecec; border: 1px solid #ffc1c1; padding: 12px; border-radius: 8px; }
    button#submit {
      width: var(--control); max-width: 100%; padding: 12px; border: none; border-radius: 10px;
      font-size: 1rem; background: #222; color: #fff; display: block; margin: 8px auto 0; cursor: pointer;
    }
    button#submit[disabled] { opacity: .6; cursor: default; }
    .footer { color: #888; font-size: .85rem; text-align: center; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>カレー モバイルオーダー</h1>
    <p class="muted">お支払いは店頭にてお願いします。送信後に注文番号が表示されます。</p>

    <fieldset>
      <legend>メニュー</legend>

      <label for="curry">カレー</label>
      <select id="curry" class="ctrl" aria-label="カレーを選択">
        <option value="キーマカレー" data-price="600">キーマカレー（¥600）</option>
        <option value="バターチキンカレー" data-price="600">バターチキンカレー（¥600）</option>
        <option value="ビーフカレー" data-price="600">ビーフカレー（¥600）</option>
      </select>

      <label>ごはん</label>
      <div class="radios ctrl" role="radiogroup" aria-label="ごはんの種類">
        <label><input type="radio" name="rice" value="白米" checked> 白米</label>
        <label><input type="radio" name="rice" value="玄米"> 玄米</label>
      </div>

      <label for="qty">数量</label>
      <!-- 数量はセレクト（1〜10）で誤操作回避 -->
      <select id="qty" class="ctrl" aria-label="数量">
        <option value="1" selected>1</option>
        <option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option>
        <option value="6">6</option><option value="7">7</option>
        <option value="8">8</option><option value="9">9</option>
        <option value="10">10</option>
      </select>

      <div class="total ctrl">合計：<span id="total">¥600</span></div>
    </fieldset>

    <fieldset>
      <legend>お客様情報</legend>
      <label for="name">お名前（必須）</label>
      <input id="name" class="ctrl" type="text" placeholder="例：山田太郎" required />

      <label for="note">備考（任意）</label>
      <textarea id="note" class="ctrl" rows="3" placeholder="辛さの希望・アレルギー等があれば記入してください"></textarea>
    </fieldset>

    <div id="msg" class="msg" aria-live="polite"></div>
    <button id="submit">この内容で注文する</button>
    <div class="footer">※ 通信状況により数秒かかる場合があります。送信中はボタンが無効になります。</div>
  </div>

<script>
  // ★ 指定エンドポイント
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzhBeRBun0jGOXnxwU40NMkNfqpmkcMTAMCgFiXfhEngtEfKUnZmBP8dd0uTjH4LgWgww/exec';

  const $ = (sel) => document.querySelector(sel);
  const curry = $('#curry');
  const qty   = $('#qty');
  const total = $('#total');
  const msg   = $('#msg');
  const submit= $('#submit');

  function getRice() {
    const r = document.querySelector('input[name="rice"]:checked');
    return r ? r.value : '白米';
  }

  function calcTotal() {
    const price = Number(curry.selectedOptions[0].dataset.price || 600);
    const q = Math.min(10, Math.max(1, Number(qty.value || 1)));
    total.textContent = `¥${(price * q).toLocaleString()}`;
    return price * q;
  }
  curry.addEventListener('change', calcTotal);
  qty.addEventListener('change', calcTotal);
  calcTotal();

  function ui(loading) {
    submit.disabled = !!loading;
    submit.textContent = loading ? '送信中…' : 'この内容で注文する';
  }

  async function sendOrder() {
    msg.innerHTML = '';
    const name = $('#name').value.trim();
    const note = $('#note').value.trim();
    if (!name) { msg.innerHTML = '<div class="error">お名前を入力してください。</div>'; return; }

    const payload = {
      name,
      curry: curry.value,
      rice: getRice(),
      quantity: Number(qty.value || 1),
      note
    };

    try {
      ui(true);
      const res = await fetch(GAS_ENDPOINT, { method: 'POST', body: JSON.stringify(payload) });
      const data = await res.json();
      if (data && data.ok) {
        // ★ 強い遷移：現在パスの末尾を thankyou.html に置換し、必ずクエリを付ける
        const url = new URL(window.location.href);
        url.pathname = url.pathname.replace(/[^/]*$/, 'thankyou.html');
        url.searchParams.set('order', String(data.order_id));
        url.searchParams.set('total', String(data.total || calcTotal()));
        location.assign(url.toString());
      } else {
        throw new Error(data && data.error ? data.error : 'unknown error');
      }
    } catch (err) {
      msg.innerHTML = `<div class="error">送信に失敗しました：${String(err.message || err)}</div>`;
    } finally {
      ui(false);
    }
  }
  submit.addEventListener('click', sendOrder);
</script>
</body>
</html>
